<UserControl x:Class="PadForge.Views.DevicesPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime">

    <Grid Margin="24,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
            <TextBlock Text="Devices" Style="{StaticResource TitleTextBlockStyle}"/>
            <Button Content="Refresh" Margin="16,0,0,0"
                    Command="{Binding RefreshCommand}"/>
            <TextBlock VerticalAlignment="Center" Margin="16,0" Opacity="0.6">
                <Run Text="{Binding OnlineCount, Mode=OneWay}"/>
                <Run Text="online /"/>
                <Run Text="{Binding TotalCount, Mode=OneWay}"/>
                <Run Text="total"/>
            </TextBlock>
        </StackPanel>

        <!-- Main content: Grid + Detail -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>

            <!-- Device list -->
            <DataGrid ItemsSource="{Binding Devices}"
                      SelectedItem="{Binding SelectedDevice, Mode=TwoWay}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True" SelectionMode="Single"
                      CanUserAddRows="False" CanUserDeleteRows="False"
                      HeadersVisibility="Column"
                      GridLinesVisibility="Horizontal"
                      BorderThickness="1"
                      Margin="0,0,12,0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Name" Binding="{Binding DeviceName}" Width="*"/>
                    <DataGridTextColumn Header="Status" Binding="{Binding StatusText}" Width="70"/>
                    <DataGridTextColumn Header="Type" Binding="{Binding DeviceType}" Width="80"/>
                    <DataGridTextColumn Header="VID" Binding="{Binding VendorIdHex}" Width="50"/>
                    <DataGridTextColumn Header="PID" Binding="{Binding ProductIdHex}" Width="50"/>
                    <DataGridTextColumn Header="Slot" Binding="{Binding AssignedSlotText}" Width="80"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- Detail panel -->
            <Border Grid.Column="1"
                    Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                    CornerRadius="8" Padding="12,10">
                <StackPanel Visibility="{Binding HasSelectedDevice, Converter={StaticResource BoolToVisibilityConverter}}">

                    <TextBlock Text="{Binding SelectedDevice.DeviceName}"
                               FontSize="16" FontWeight="SemiBold"
                               TextWrapping="Wrap" Margin="0,0,0,6"/>

                    <!-- Identity -->
                    <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                        <Run Text="Product:"/>
                        <Run Text="{Binding SelectedDevice.ProductName, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                        <Run Text="VID:PID:"/>
                        <Run Text="{Binding SelectedDevice.VendorIdHex, Mode=OneWay}"/>
                        <Run Text=":"/>
                        <Run Text="{Binding SelectedDevice.ProductIdHex, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock FontSize="11" Opacity="0.7" Margin="0,0,0,1">
                        <Run Text="Type:"/>
                        <Run Text="{Binding SelectedDevice.DeviceType, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock FontSize="11" Opacity="0.6" Margin="0,0,0,1">
                        <Run Text="{Binding SelectedDevice.CapabilitiesSummary, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock FontSize="10" Opacity="0.45" Margin="0,0,0,4"
                               TextWrapping="Wrap" FontFamily="Consolas">
                        <Run Text="GUID:"/>
                        <Run Text="{Binding SelectedDevice.InstanceGuid, Mode=OneWay}"/>
                    </TextBlock>

                    <Separator Margin="0,2,0,6"/>

                    <!-- Assign to slot + Remove -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <Button Content="P1" Margin="0,0,3,0" MinWidth="32" Padding="4,3"
                                Command="{Binding AssignToSlotCommand}">
                            <Button.CommandParameter><sys:Int32>0</sys:Int32></Button.CommandParameter>
                        </Button>
                        <Button Content="P2" Margin="0,0,3,0" MinWidth="32" Padding="4,3"
                                Command="{Binding AssignToSlotCommand}">
                            <Button.CommandParameter><sys:Int32>1</sys:Int32></Button.CommandParameter>
                        </Button>
                        <Button Content="P3" Margin="0,0,3,0" MinWidth="32" Padding="4,3"
                                Command="{Binding AssignToSlotCommand}">
                            <Button.CommandParameter><sys:Int32>2</sys:Int32></Button.CommandParameter>
                        </Button>
                        <Button Content="P4" Margin="0,0,8,0" MinWidth="32" Padding="4,3"
                                Command="{Binding AssignToSlotCommand}">
                            <Button.CommandParameter><sys:Int32>3</sys:Int32></Button.CommandParameter>
                        </Button>
                        <Button Content="Remove" Padding="8,3"
                                Command="{Binding RemoveDeviceCommand}"
                                ToolTip="Remove this device and its settings"/>
                    </StackPanel>

                    <Separator Margin="0,2,0,6"/>

                    <!-- Raw state -->
                    <TextBlock Text="Raw Input State" FontWeight="SemiBold"
                               FontSize="12" Margin="0,0,0,4"/>

                    <TextBlock Text="Axes" FontSize="11" Opacity="0.6" Margin="0,0,0,1"/>
                    <TextBlock Text="{Binding RawAxisDisplay}" FontSize="10"
                               FontFamily="Consolas" TextWrapping="Wrap"
                               MaxHeight="100" Margin="0,0,0,5"/>

                    <TextBlock Text="Buttons" FontSize="11" Opacity="0.6" Margin="0,0,0,1"/>
                    <TextBlock Text="{Binding RawButtonDisplay}" FontSize="10"
                               FontFamily="Consolas" TextWrapping="Wrap"
                               Margin="0,0,0,5"/>

                    <TextBlock Text="POV Hats" FontSize="11" Opacity="0.6" Margin="0,0,0,1"/>
                    <TextBlock Text="{Binding RawPovDisplay}" FontSize="10"
                               FontFamily="Consolas" TextWrapping="Wrap"/>

                    <!-- Gyroscope (visible only when the device has a gyro sensor) -->
                    <TextBlock Text="Gyroscope" FontSize="11" Opacity="0.6" Margin="0,5,0,1"
                               Visibility="{Binding RawGyroDisplay, Converter={StaticResource StringToVisibility}}"/>
                    <TextBlock Text="{Binding RawGyroDisplay}" FontSize="10"
                               FontFamily="Consolas" TextWrapping="Wrap"
                               Visibility="{Binding RawGyroDisplay, Converter={StaticResource StringToVisibility}}"/>

                    <!-- Accelerometer (visible only when the device has an accel sensor) -->
                    <TextBlock Text="Accelerometer" FontSize="11" Opacity="0.6" Margin="0,5,0,1"
                               Visibility="{Binding RawAccelDisplay, Converter={StaticResource StringToVisibility}}"/>
                    <TextBlock Text="{Binding RawAccelDisplay}" FontSize="10"
                               FontFamily="Consolas" TextWrapping="Wrap"
                               Visibility="{Binding RawAccelDisplay, Converter={StaticResource StringToVisibility}}"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
